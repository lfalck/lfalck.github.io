{"componentChunkName":"component---src-templates-blog-post-js","path":"/azure-rest-apis-postman/","result":{"data":{"markdownRemark":{"html":"<p>I like to use <a href=\"https://getpostman.com\">Postman</a> while developing and testing HTTP APIs and thought it would be nice to add support for other integration scenarios as well, so I have created Postman collections for Azure Service Bus, Event Hubs, Event Grid and Storage (blob storage and queues for now).</p>\n<p>You can check them out on <a href=\"https://github.com/lfalck/AzureRestApiPostmanCollections\">GitHub</a> and continue reading if you are interested in the implementation details.</p>\n<h2>Azure Service Bus and Event Hubs</h2>\n<p>To use the Azure Service Bus and Event Hubs REST APIs a SAS token needs to be included in the Authorization header of all operations. A SAS token grants time limited permissions to a particular Azure resource. Brent Stineman wrote <a href=\"https://brentdacodemonkey.wordpress.com/2015/02/21/sas-its-just-another-token\">a great blog post</a> with more details.</p>\n<p>Examples how to generate SAS tokens can be found <a href=\"https://docs.microsoft.com/en-us/rest/api/eventhub/generate-sas-token\">here</a>, and since Postman uses JavaScript as its scripting language the NodeJS part is what is interesting. Unfortunately, the example uses the <code class=\"language-text\">crypto</code> and <code class=\"language-text\">utf8</code> npm packages, and there is currently no way to use external libraries in Postman. However, Postman has a number of <a href=\"https://www.getpostman.com/docs/postman/scripts/postman_sandbox_api_reference\">built-in library modules</a> and <code class=\"language-text\">crypto-js</code> is the one that is useful in this case. </p>\n<p>This is the NodeJS example from the link above but rewritten to use <code class=\"language-text\">crypto-js</code>. I also lowered the lifetime of the token to one minute since we will regenerate it for each request.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createServiceBusOrEventHubsSASToken</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resourceUri<span class=\"token punctuation\">,</span> sasKeyName<span class=\"token punctuation\">,</span> sasKey</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>resourceUri <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>sasKeyName <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>sasKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token string\">\"Missing required parameter\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> encoded <span class=\"token operator\">=</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>resourceUri<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> now <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> minute <span class=\"token operator\">=</span> <span class=\"token number\">60</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> ttl <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> minute<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> signature <span class=\"token operator\">=</span> encoded <span class=\"token operator\">+</span> <span class=\"token string\">'\\n'</span> <span class=\"token operator\">+</span> ttl<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> hash <span class=\"token operator\">=</span> CryptoJS<span class=\"token punctuation\">.</span><span class=\"token function\">HmacSHA256</span><span class=\"token punctuation\">(</span>signature<span class=\"token punctuation\">,</span> sasKey<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span>CryptoJS<span class=\"token punctuation\">.</span>enc<span class=\"token punctuation\">.</span>Base64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'SharedAccessSignature sr='</span> <span class=\"token operator\">+</span> encoded <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;sig='</span> <span class=\"token operator\">+</span>\n        <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;se='</span> <span class=\"token operator\">+</span> ttl <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;skn='</span> <span class=\"token operator\">+</span> sasKeyName<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This function is used in a collection level pre-request script which means it will run before every request in the collection. The parameters to the script are taken from collection variables and the resulting token is stored in another collection variable and used in in all requests.</p>\n<h2>Azure Storage</h2>\n<p>Creating a collection for Azure storage was more straightforward since you have the ability to generate an account level SAS query string directly in the portal by going to a storage account in the Azure Portal and clicking <strong>Shared access signature</strong>. </p>\n<h2>Azure Event Grid</h2>\n<p>The only relevant action available for Azure Event Grid is to send events to custom Topics. Authentication is provided by a SAS key in a custom header called <strong>aeg-sas-key</strong>.</p>\n<p>The body format looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{{$guid}}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"eventType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"recordInserted\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"subject\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"myapp/messages\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"eventTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{{currentTime}}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Hello World Event Grid!\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"dataVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p><code class=\"language-text\">{{$guid}}</code> is a dynamic Postman variable which generates a GUID and <code class=\"language-text\">{{currentTime}}</code> is populated with a timestamp in a pre-request script.</p>\n<p>That is all, have a good day!</p>","frontmatter":{"title":"Azure REST API Postman collections for integration","canonicalURL":"azure-rest-apis-postman","date":"Apr 9, 2018","noPage":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/azure-rest-apis-postman/"}}}